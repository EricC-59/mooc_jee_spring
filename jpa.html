<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Ressources pédagogiques pour le MOOC Java EE Spring prêt à l'emploi">
    <meta name="author" content="Guillaume Dufrêne, Lionel Seinturier, Julien Wittouck">
    
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap/ie10-viewport-bug-workaround.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
  </head>
  <body>


<!-- Fixed navbar -->
 <nav class="navbar navbar-default navbar-fixed-top">
   <div class="container">
     <div class="navbar-header">
       <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
         <span class="sr-only">Toggle navigation</span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
       </button>
       <a class="navbar-brand" href="index.html">Java EE Spring ////</a>
     </div>
     <div id="navbar" class="navbar-collapse collapse">
       <div class="nav navbar-nav subtitle hidden-xs">Prêt à l'emploi</div>
       <ul class="nav navbar-nav navbar-right">
         <li>
           <a href="index.html">Accueil</a>
         </li><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
             Outils <span class="caret"></span>
           </a>
           <ul class="dropdown-menu">
             <li><a href="git.html">Git</a></li>
             <li><a href="maven.html">Maven</a></li>
             <li><a href="docker.html">Docker</a></li>
             <li><a href="ci-cd.html">CI/CD</a></li>
           </ul>
         </li><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                Java EE <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <li><a href="java.html">Java</a></li>
                <li><a href="tomcat.html">Tomcat</a></li>
                <li><a href="servlet.html">Servlet / JSP</a></li>
                <li><a href="jstl.html">JSTL</a></li>
                <li><a href="jdbc.html">JDBC</a></li>
                <li><a href="jpa.html">JPA</a></li>
              </ul>
         </li><li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                 Spring <span class="caret"></span>
               </a>
               <ul class="dropdown-menu">
                 <li><a href="spring.html">Context - IoC</a></li>
                 <li><a href="spring-mvc.html">Web MVC</a></li>
                 <li><a href="jstl.html#spring-form">JSTL taglib</a></li>
                 <li><a href="spring-mvc.html#spring-orm">ORM</a></li>
                 <li><a href="spring-data.html">Spring Data</a></li>
                 <li><a href="#">Spring Boot</a></li>
               </ul>
          </li>
       </ul>
     </div><!--/.nav-collapse -->
   </div>
   <div class="clear"></div>
 </nav>


<div class="container">
<h2><a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a>JPA</h2>

<p>
JPA (Java Persistance Api) est une spécification Java EE permettant de lier des objets à des données contenues dans une base de données. Plus exactement, dans toute source de données possédant une implémentation correspondante.
</p>

<p>
JPA est essentiellement utilisé pour la manipulation des bases de données relationnelles construites à partir du développement orienté objet en Java. Comme tout ORM, JPA fournit une abstraction d'accès à la base de données. Il n'est donc plus question d'écrire du code SQL "natif" de votre base. Les opérations de création, recherche, mise à jour et suppression des données sont complètement accessibles via des méthodes génériques.
</p>

<p>
En fonction de la persistance choisie, l'implémentation JPA pour votre base se chargera de traduire ces appels en SQL (ou autre) valide.
</p>


<p>
La vidéo suivante est une présentation générale de JPA.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/q5UtDiYQBgA?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="pdf/3.1_jpa.pdf">Transparents présentés dans la vidéo</a>
</p>

<p>
La suite de cette page explique comment mettre en oeuvre JPA à l'aide de l'implémentation Hibernate.
</p>

<h3>Hibernate</h3>

<p>
Essayons de mettre en oeuvre une persistance JPA avec l'implémentation Hibernate par dessus une base de données "H2".
</p>

<p>
Hibernate est un "gros" framework qui implémente les fonctionnalités de JPA. Il possède un nombre assez important de dépendances. Il devient assez vite compliqué de vouloir chercher toutes ces dépendances "à la main". Nous allons plutôt utiliser Maven pour gérer tout cela.<br/>
</p>

<h3>Premières entités</h3>

<p>
  Avec JPA, nous pouvons annoter nos classes Java pour indiquer que les données de ces classes seront persistées. De manière simple, il "suffit" de placer l'annotation <code class="ann">@Entity</code> sur une classe pour que cela fonctionne ... ou presque. Il est nécessaire que les propriétés de l'objet à persister soient accessibles par le gestionnaire d'entité.
</p>

<p>
  Comprenez :<br/>
- soit une propriété public ;<br/>
- soit un getter / setter avec le nom qui correspond get<i>Propriété</i> et set<i>Propriété</i>( valeur ).<br/>
- sinon l'implémentation JPA (hibernate) pourra essayer de modifier dynamiquement le bytecode pour rendre ces propriétés accessibles.
</p>

<p>
  Pour certaines propriétés, il est utile de mettre d'autres annotations pour indiquer comment le gestionnaire ou la base se comportera. Par exemple l'identifiant de l'entité doit être annoté <code class="ann">@Id</code>. Nous pouvons aussi indiquer que cette propriété sera générée par la base via une séquence (ou auto increment). Pour cela nous ajoutons la propriété <code class="ann">@GeneratedValue</code>
</p>

<h3>Les associations</h3>

<p>
  Pour marquer les relations entre nos entités il est possible d'utiliser les annotations :<br/>
  &raquo; <code class="ann">@OneToMany</code> : pour désigner une relation 1-n, soit une instance faisant référence à plusieurs autres. Permet d'accéder aux objets du coté N à travers une liste. A utiliser avec vigilance selon la volumétrie des données associées.<br/>
  &raquo; <code class="ann">@ManyToOne</code> : pour désigner, une relation inverse de 1-n. Permet d'accéder facilement à l'objet du coté "1".<br/>
  &raquo; <code class="ann">@OneToOne</code> : pour désigner une relation 1-1 entre deux objets. Peut être utile pour séparer un ensemble de propriétés dont le sens est différent. Peut être utile pour concevoir une relation d'héritage également.<br/>
  &raquo; <code class="ann">@ManyToMany</code> : pour les relations n-n devenant une table associative.<br/>
</p>

<p>
  Certaines associations N-N du modèle peuvent comporter des informations. Dans ce cas, il est préférable d'utiliser deux liens OneToMany vers une classe qui portera ces informations.<br/>
  Pour gérer l'association correctement, il y a ensuite deux stratégies concernant la clé primaire :<br/>
  1. Réaliser une clé composée à l'aide de EmbeddedId ; (Voir <a href="http://www.mkyong.com/hibernate/hibernate-many-to-many-example-join-table-extra-column-annotation/">cette explication</a>)<br/>
  2. Ajouter une simple clé (colonne supplémentaire) et mettre une contrainte d'unicité sur les colonnes des deux clé étrangères. ; (Voir <a href="http://stackoverflow.com/questions/5127129/mapping-many-to-many-association-table-with-extra-columns">cette explication</a>)<br/>
</p>

<h3>persistence.xml</h3>

<p>
  Si vous utilisez JPA sans autre framework (type Spring), le "contexte de persistance" se configure avec un fichier "persistence.xml" placé dans le <b>classpath</b>, dans un répertoire "META-INF/". Dans un projet Maven, ce fichier est généralement placé dans les "resources" principales. Il faut créer un répertoire WEB-INF/resources/META-INF et y mettre ce contenu :</a>.<br/>
</p>

<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;persistence xmlns=&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;
             xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
             xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/persistence
             http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd&quot;
             version=&quot;2.1&quot;&gt;
&lt;persistence-unit name=&quot;myApp&quot;&gt;
&lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;
&lt;properties&gt;
  &lt;property name=&quot;javax.persistence.jdbc.driver&quot;   value=&quot;org.h2.Driver&quot;/&gt;
  &lt;property name=&quot;javax.persistence.jdbc.url&quot;      value=&quot;jdbc:h2:./db&quot;/&gt;
  &lt;property name=&quot;javax.persistence.jdbc.show_sql&quot; value=&quot;true&quot;/&gt;
  &lt;property name=&quot;hibernate.dialect&quot;       value=&quot;org.hibernate.dialect.H2Dialect&quot;/&gt;
  &lt;property name=&quot;hibernate.hbm2ddl.auto&quot;  value=&quot;create-drop&quot;/&gt;
&lt;/properties&gt;
&lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre>

<p>
  Ce fichier est évidemment à adapter selon vos besoins.<br/>
  Prêtez notamment attention au paramètre "hbm2ddl.auto" et lisez cette page de <a href="http://stackoverflow.com/questions/438146/hibernate-hbm2ddl-auto-possible-values-and-what-they-do">stackOverflow</a>.
</p>

<h3>Entity Manager</h3>

<p>
  L'Entity Manager permet de sauvegarder (persist), charger (find), ou créer des requêtes exprimées en JPQL ... une sorte de SQL orienté objet. Notez qu'il est aussi possible de créer des requêtes à l'aide de l'API Criteria de JPA. Pour tout cela, il y a la doc. Consultez par exemple <a href="http://www.objectdb.com/java/jpa/query">ce site</a> ou encore LA <a href="http://docs.oracle.com/cd/E13189_01/kodo/docs40/full/html/ejb3_overview_query.html">doc officielle</a>, un peu moins agréable.<br/>
Vous pouvez aussi vous plonger dans la <a href="http://docs.oracle.com/javaee/7/api/index.html?javax/persistence/EntityManager.html">javadoc</a>, encore plus austère.
</p>

<p>
  Vous pouvez consulter la classe <a href="files/DemoJPA.java">DemoJPA</a> pour voir un exemple simple d'usage de l'entity manager et des transactions. Toutes les requêtes JPA doivent être exécutées dans une transaction. On "oblige" le développeur à se soucier de ce qui a du sens en terme d'état de base de données. Si une exception survient durant la transaction, les modifications en base ne sont pas appliquées (ou défaites).
</p>

<p>
  Le screencast illustre l'utilisation de l'Entity Manager de JPA.<br/>
  Dans ce projet les dépendances sont gérées par <a href="maven.html">Maven</a>.<br/>
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/0QILkWt2Hzw?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="https://github.com/gdufrene/mooc_jee_spring/raw/master/week3/screencast/sc09.zip">Code présenté dans le screencast</a>
</p>


<p>
  Bien que ce ne soit pas recommandé, il reste possible d'effectuer des requête SQL à travers l'API JPA.<br/>
  Le mapping peut rester "automatique" si toutefois votre résultat de requête reste compatible avec l'objet à affecter.<br/>
</p>

<pre>
  String sql = "SELECT * FROM USER WHERE ID = ?";

  Query query = entityManager.createNativeQuery(sql, User.class);
  query.setParameter(1, id);
  User user = (User) query.getSingleResult();
</pre>


<h3>Les transactions JPA</h3>

<p>
  JPA impose l'usage de transaction dès lors que vous souhaitez modifier les données.
</p>

<p>
Une transaction est un mécanisme qui permet d'exécuter de façon sûre une modification sur une base de données : soit la modification est effectuée complètement, soit elle n'est pas effectuée du tout. On obtient ainsi la garantie qu'une modification ne sera jamais exécutée partiellement, ce qui risquerait de laisser les données de la base dans un état incohérent.
</p>

<p>
Une transaction apporte également des propriétés clés dès lors que plusieurs utilisateurs accèdent aux mêmes données simultanément. On obtient la garantie que les modifications faites par un utilisateur ne perturbent pas le fonctionnement des autres utilisateurs.
</p>

<p>
L'exemple "Hello World!" qui illustre l'utilisation des transactions est le transfert d'une somme d'argent entre deux comptes bancaires : il faut débiter un compte et en créditer un autre. Soit le transfert est effectué complètement, soit il ne doit pas l'être du tout. Il ne s'agit en aucune sorte que de l'argent disparaisse en débitant un compte sans créditer l'autre. Les transactions permettent d'obtenir une telle garantie.
</p>

<p>Concrètement, les transactions sont mises en oeuvre à l'aide de trois opérations :
</p>

<ul>
<li><code>begin</code> : démarre la transaction.</li>
<li><code>commit</code> : termine la transaction.</li>
<li><code>rollback</code> : annule la transaction et remet la base dans l'état antérieur au démarrage de la transaction.</li>
</ul>

<p>
La vidéo suivante présente l'utilisation des transactions avec JPA.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/jP7c4yJKGAA?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="pdf/3.3_transaction.pdf">Transparents présentés dans la vidéo</a>
</p>


<h3>JPQL</h3>

<p>
JPA propose un language de requêtage proche de SQL afin de manipuler les données. Le point de vue est orienté "entité" et les opérations de filtrage ou de jointure sont décrites en fonction des attributs.<br/>
Ce language permet de s'abstraire du modèle relationnel et des subtilités de différence entre le SQL implémenté par chaque gestionaire de base de données.
</p>

<p>
  Le screencast suivant montre l'usage d'opérations courantes sur les entités à l'aide de JPQL.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/AgH0nprln4c?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="https://github.com/gdufrene/mooc_jee_spring/raw/master/week3/screencast/sc10.zip">Code présenté dans le screencast</a>
</p>

<h3>API Criteria</h3>

<p>
L'API Criteria de JPA offre la possibilité de construire les requêtes de manière programmatique, c'est-à-dire en utilisant des objets et des méthodes Java. C'est une alternative à JPQL pour les requêtes de type <code>SELECT</code>. Alors qu'en JPQL (comme en JDBC) les requêtes sont définies avec des chaînes de caractères, les requêtes avec l'API Criteria sont définies via l'instantiation d'objets Java qui représentent les éléments de la requête. Cela donne un code plus fortement typé qui permet d'éviter les erreurs de syntaxe inhérentes à la manipulation de chaînes de caractères.
</p>

<p>
Comme toute API, Criteria propose au développeur un ensemble de méthodes. En plus de cela, Criteria génère des métadonnées pour les entités de l'application. Chaque donnée d'une entité est ainsi associée à un métaparamètre qui est généré automatiquement par Criteria. Le développeur peut alors utiliser ces métaparamètres pour construire des requêtes fortement typées.
</p>

<p>
La vidéo suivante présente l'API Criteria.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/7Y931lSvj8g?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="pdf/3.4_criteria.pdf">Transparents présentés dans la vidéo</a>
</p>


<p>
  Le screencast suivant reprend les entités du screencast JPQL pour effectuer un ensemble d'opérations similaires à l'aide de l'API Criteria.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/X-e1nJKbSHY?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="https://github.com/gdufrene/mooc_jee_spring/raw/master/week3/screencast/sc10.zip">Code présenté dans le screencast</a>
</p>


<h3>Héritage et persistance</h3>

<p>
  Les entités JPA sont représentés sous la forme de classe Java. Il devient alors possible de créer un arbre d'héritage entre nos entités. Mais comment ces données sont-elles persitées dans une base de données relationnelles ?<br/>
  La vidéo suivante vous détaille les stratégies de persistance proposées par JPA.
</p>

<p align="center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/L5Cp_DQDI-0?rel=0" frameborder="0" allowfullscreen=""></iframe>
</p>

<p align="center">
<a href="pdf/3.5_hierarchie_de_classes.pdf">Transparents présentés dans la vidéo</a>
</p>


<h2><a name="exercice"></a>Exercice</h2>

<p>
Nous vous proposons un exercice qui permettra de vous familiariser par la pratique avec JPA.
</p>

<ul>
  <li><a href="https://github.com/gdufrene/mooc_jee_spring/tree/master/week3/exo301#exercice-301">Mise en oeuvre avec JPA d'un schéma de données pour un site de e-commerce</a></li>
</ul>

    <footer>
      <p>
        <img align="right" src="img/UL-2014.png" height="80"/>
        Projet réalisé par 
        <a href="https://github.com/gdufrene">
          Guillaume Dufrêne</a>, 
        <a href="http://www.lifl.fr/~seinturi/">
          Lionel Seinturier</a>,
        <a href="https://github.com/juwit">
          Julien Wittouck</a>
        - Université de Lille
        <br/>
        Hosted on GitHub Pages &mdash; Theme by <a href="http://semm.univ-lille1.fr/">SEMM</a> / B. Dufrêne
      </p>
      <p>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
          <img style="float: left, margin: 10px" alt="Licence Creative Commons" style="border-width:0" src="https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png" />
        </a>
        Cette œuvre est mise à disposition selon les termes de la Licence :<br/>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
          Creative Commons Attribution <br/>
          - Pas d’Utilisation Commerciale <br/>
          - Partage dans les Mêmes Conditions <br/>
          4.0 International</a>.
      </p>
    </footer>
    
</div> <!-- container -->

    <script src="bootstrap/jquery.min.js"></script>
    <script src="bootstrap/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="bootstrap/ie10-viewport-bug-workaround.js"></script>
    
  </body>
</html>
